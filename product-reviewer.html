<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Group Reviewer</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABWklEQVR4AZSPsauBURjGf/feuossIgPZLQbJJFnEZrOapCzKqmz8D0aJMiiTlMnCIAwii5XEZuCK3HM6Pq5OudT7vOf5zvs+v77zeYG80I/Q5U3JTP4TyAl9C71bMpOTAGn0sM0GwaCS3a7P1c23BChrdJcLGg1YraDbVVouodkEq9XYup2PgK8vqNVgOIRwGCwWcLuh3YZYDCqVW9Awj4DzGQIBKJWgWgWzGeZzyGTUfiQCJpPy1/4IuF6SzYJ892ajbiRYutMJDC+/hXTAxwckErBYwH4vVkTF46KJajbhcBDmXjrA5wOHAwYDSCah1YJiEUYjSKfvyavTAaGQGo3H0OtBvQ7RKPj9sN2q2Z+uA7xeNV6vYTqFchk6He3tagl0gNOpZrudOv/pOsAIyD8w/JNTB6RS4PFAv/8kdh9JwPH+KdxsBpOJMC/VUQIKYvURIi5eKJkp/AIAAP//GbHGGAAAAAZJREFUAwBtEXLzW3c1JQAAAABJRU5ErkJggg==">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        
        .progress-bar {
            background: linear-gradient(to right, #3b82f6 var(--progress, 0%), #e5e7eb var(--progress, 0%));
            height: 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-outline {
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .btn-outline:hover {
            background: #f9fafb;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #3b82f6;
        }
        
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        .checkbox {
            width: 16px;
            height: 16px;
            accent-color: #3b82f6;
        }
        
        .select {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background: white;
            min-width: 200px;
        }
        
        .input {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background: white;
        }
        
        .icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { motion, AnimatePresence } = Motion;

        // Sample data for the product reviewer
        const SAMPLE_DATA = [
            {
                product_id: "1",
                supplier: "BuildCorp",
                name: "Portland Cement 25kg Bag",
                suggested: "Concrete",
                confidence: 0.95
            },
            {
                product_id: "2",
                supplier: "WoodWorks Ltd",
                name: "Oak Hardwood Flooring 20mm",
                suggested: "Timber",
                confidence: 0.88
            },
            {
                product_id: "3",
                supplier: "SteelMax",
                name: "Reinforcing Steel Bar 12mm",
                suggested: "Concrete",
                confidence: 0.75
            },
            {
                product_id: "4",
                supplier: "BrickCo",
                name: "Red Clay Bricks 215x102x65mm",
                suggested: "Bricks and Blocks",
                confidence: 0.92
            },
            {
                product_id: "5",
                supplier: "InsuloPro",
                name: "Mineral Wool Insulation 100mm",
                suggested: "Insulation",
                confidence: 0.85
            },
            {
                product_id: "6",
                supplier: "AggSupply",
                name: "20mm Crushed Stone Aggregate",
                suggested: "Aggregate",
                confidence: 0.90
            },
            {
                product_id: "7",
                supplier: "PlasterPlus",
                name: "Gypsum Plasterboard 12.5mm",
                suggested: "Plasterboard",
                confidence: 0.87
            },
            {
                product_id: "8",
                supplier: "TimberCraft",
                name: "Treated Pine Lumber 90x45mm",
                suggested: "Timber",
                confidence: 0.82
            }
        ];

        const DEFAULT_CLASSES = [
            "Aggregate",
            "Aluminium",
            "Asphalt",
            "Bricks and Blocks",
            "Cement",
            "Cladding",
            "Concrete",
            "Earthworks",
            "Electrical",
            "Fasteners",
            "Finishes",
            "Fuels",
            "Furnishings",
            "Glass",
            "Insulation",
            "Mechanical",
            "Metals",
            "Network Systems",
            "Openings",
            "Other",
            "Plasterboard",
            "Plumbing",
            "Precast Concrete",
            "Rebar",
            "Structural Steel",
            "Timber",
            "Tools and Equipment",
        ];

        const STORAGE_KEY = "pgr_session_preview";

        function useLocalSession() {
            const [session, setSession] = useState({ labeled: {} });
            
            useEffect(() => {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (raw) {
                    try { 
                        setSession(JSON.parse(raw)); 
                    } catch {}
                }
            }, []);
            
            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(session));
            }, [session]);
            
            return { session, setSession };
        }

        // Simplified UI Components
        function Card({ children, className = "" }) {
            return <div className={`card p-6 ${className}`}>{children}</div>;
        }

        function Button({ children, onClick, variant = "primary", disabled = false, className = "" }) {
            const variantClass = variant === "secondary" ? "btn-secondary" : 
                               variant === "outline" ? "btn-outline" : 
                               variant === "success" ? "btn-success" : "btn-primary";
            return (
                <button 
                    className={`btn ${variantClass} ${className}`}
                    onClick={onClick}
                    disabled={disabled}
                >
                    {children}
                </button>
            );
        }

        function Badge({ children, variant = "default" }) {
            return <span className="badge">{children}</span>;
        }

        function Progress({ value }) {
            return (
                <div className="progress-bar" style={{"--progress": `${value}%`}}></div>
            );
        }

        function Switch({ checked, onCheckedChange }) {
            return (
                <label className="switch">
                    <input 
                        type="checkbox" 
                        checked={checked}
                        onChange={(e) => onCheckedChange(e.target.checked)}
                    />
                    <span className="slider"></span>
                </label>
            );
        }

        function Select({ children, onValueChange, placeholder, value, onReset }) {
            return (
                <select 
                    className="select"
                    value={value || ""}
                    onChange={(e) => onValueChange(e.target.value)}
                >
                    <option value="" disabled>{placeholder}</option>
                    {children}
                </select>
            );
        }

        function SelectItem({ children, value }) {
            return <option value={value}>{children}</option>;
        }

        function Checkbox({ checked, onCheckedChange }) {
            return (
                <input 
                    type="checkbox"
                    className="checkbox"
                    checked={checked}
                    onChange={(e) => onCheckedChange(e.target.checked)}
                />
            );
        }

        // Similarity functions
        function tfidfScore(a, b) {
            const A = a.toLowerCase().split(/\W+/).filter(Boolean);
            const B = b.toLowerCase().split(/\W+/).filter(Boolean);
            if (!A.length || !B.length) return 0;
            
            // Enhanced word weighting for product similarity
            const importantWords = new Set([
                'matt', 'matte', 'gloss', 'satin', 'eggshell', 'silk',
                'white', 'black', 'red', 'blue', 'green', 'yellow', 'grey', 'gray',
                'paint', 'primer', 'undercoat', 'topcoat', 'emulsion',
                'trade', 'contract', 'diamond', 'professional',
                'interior', 'exterior', 'wood', 'metal', 'brick', 'block',
            ]);
            
            const all = [...A, ...B];
            const freq = {};
            for (const w of all) freq[w] = (freq[w] || 0) + 1;
            
            let inter = 0, denom = 0;
            const setA = new Set(A);
            const setB = new Set(B);
            const union = new Set([...setA, ...setB]);
            
            for (const w of union) {
                // Give extra weight to important product characteristics
                const weight = importantWords.has(w) ? 2.0 : 1.0;
                const idf = weight / Math.sqrt(freq[w]);
                denom += idf;
                if (setA.has(w) && setB.has(w)) inter += idf;
            }
            return inter / (denom || 1);
        }

        function partial_ratio(a, b) {
            const A = a.toLowerCase();
            const B = b.toLowerCase();
            if (A === B) return 100;
            if (A && (B.includes(A) || A.includes(B))) return 95;
            
            const wa = A.split(/\W+/).filter(Boolean);
            const wb = B.split(/\W+/).filter(Boolean);
            
            // Filter out size/quantity indicators for better matching
            const sizeWords = new Set(['lt', 'l', 'litre', 'liter', 'ml', 'kg', 'g', 'gram', 'gallon', 'pint', 'quart']);
            const numericPattern = /^[\d.]+$/;
            const codePattern = /^[a-z]*\d+[a-z]*$/i; // Match codes like RAL9003, ND, etc.
            
            const filterWords = (words) => words.filter(w => 
                !sizeWords.has(w) && 
                !numericPattern.test(w) && 
                !codePattern.test(w) &&
                w.length > 1
            );
            
            const filteredA = filterWords(wa);
            const filteredB = filterWords(wb);
            
            if (filteredA.length === 0 || filteredB.length === 0) {
                // Fallback to original logic if filtering removes everything
                const setB = new Set(wb);
                const overlap = wa.filter(x => setB.has(x)).length;
                return Math.round((overlap / Math.max(wa.length, 1)) * 100);
            }
            
            const setB = new Set(filteredB);
            const overlap = filteredA.filter(x => setB.has(x)).length;
            
            // Special boost for paint/coating products
            const paintTerms = ['trade', 'matt', 'matte', 'gloss', 'satin', 'paint', 'emulsion', 'primer'];
            const finishTerms = ['white', 'black', 'base', 'light', 'dark'];
            
            let boost = 0;
            const hasSharedPaintTerms = paintTerms.some(term => 
                filteredA.includes(term) && filteredB.includes(term)
            );
            const hasSharedFinishTerms = finishTerms.some(term => 
                filteredA.includes(term) && filteredB.includes(term)
            );
            
            if (hasSharedPaintTerms) boost += 15;
            if (hasSharedFinishTerms) boost += 10;
            
            const baseScore = Math.round((overlap / Math.max(filteredA.length, 1)) * 100);
            return Math.min(100, baseScore + boost);
        }

        // Main Component
        function ProductGroupReviewer() {
            const { session, setSession } = useLocalSession();
            const [items, setItems] = useState(SAMPLE_DATA);
            const [classes, setClasses] = useState(DEFAULT_CLASSES);
            const [categories, setCategories] = useState({});
            const [groupBySupplier, setGroupBySupplier] = useState(true);
            const [index, setIndex] = useState(0);
            const [pendingReassign, setPendingReassign] = useState(null);
            const [lastSupplier, setLastSupplier] = useState(null);
            const [streak, setStreak] = useState(0);
            const [similarityThreshold, setSimilarityThreshold] = useState(0.50);
            const [selectedBatch, setSelectedBatch] = useState({});

            // Build review queue
            const queue = useMemo(() => {
                const doneIds = new Set(Object.keys(session.labeled));
                const remaining = items.filter((it) => !doneIds.has(it.product_id));
                
                if (groupBySupplier) {
                    // Group by supplier, then sort within each group by confidence
                    const supplierGroups = {};
                    
                    remaining.forEach(item => {
                        const supplier = item.supplier || 'Unknown';
                        if (!supplierGroups[supplier]) {
                            supplierGroups[supplier] = [];
                        }
                        supplierGroups[supplier].push(item);
                    });
                    
                    // Sort each supplier group by confidence (lowest first)
                    Object.values(supplierGroups).forEach(group => {
                        group.sort((a, b) => (a.confidence ?? 1) - (b.confidence ?? 1));
                    });
                    
                    // Sort suppliers by their lowest confidence product to prioritize challenging suppliers
                    const sortedSuppliers = Object.entries(supplierGroups)
                        .sort(([,a], [,b]) => {
                            const minConfA = Math.min(...a.map(item => item.confidence ?? 1));
                            const minConfB = Math.min(...b.map(item => item.confidence ?? 1));
                            return minConfA - minConfB;
                        });
                    
                    // Flatten back to single array
                    return sortedSuppliers.flatMap(([supplier, items]) => items);
                }
                
                return remaining;
            }, [items, session.labeled, groupBySupplier]);

            const total = items.length;
            const completed = Object.keys(session.labeled).length;
            const progress = total ? Math.round((completed / total) * 100) : 0;
            const current = queue[index] ?? undefined;

            // Auto-select most common category for supplier grouping
            useEffect(() => {
                if (!current || !groupBySupplier) {
                    setLastSupplier(null);
                    return;
                }
                
                const currentSupplier = current.supplier || "(unknown)";
                
                // Only auto-select if we're moving to a new supplier or first time
                if (lastSupplier !== currentSupplier) {
                    setLastSupplier(currentSupplier);
                    
                    // Find most common classification for this supplier
                    const supplierLabeled = Object.values(session.labeled)
                        .filter(item => (item.supplier || "(unknown)") === currentSupplier);
                    
                    if (supplierLabeled.length > 0) {
                        const classCounts = {};
                        supplierLabeled.forEach(item => {
                            const finalClass = item.final_class;
                            if (finalClass) {
                                classCounts[finalClass] = (classCounts[finalClass] || 0) + 1;
                            }
                        });
                        
                        if (Object.keys(classCounts).length > 0) {
                            const mostCommonClass = Object.entries(classCounts)
                                .sort(([,a], [,b]) => b - a)[0][0];
                            
                            // Only auto-select if it's different from LLM suggestion AND current pending reassign
                            const llmSuggestion = current.suggested;
                            if (mostCommonClass !== llmSuggestion && pendingReassign !== mostCommonClass) {
                                setPendingReassign(mostCommonClass);
                            } else {
                                // Clear selection if most common matches LLM suggestion
                                setPendingReassign(null);
                            }
                        }
                    } else {
                        // Clear selection for new suppliers with no history
                        setPendingReassign(null);
                    }
                }
            }, [current?.supplier, current?.suggested, groupBySupplier, session.labeled, lastSupplier]);

            // Similar items calculation
            const similar = useMemo(() => {
                if (!current) return [];
                const out = [];
                for (const it of items) {
                    if (!it || it.product_id === current.product_id) continue;
                    if (session.labeled[it.product_id]) continue;
                    
                    const simT = tfidfScore(current.name, it.name);
                    const simP = partial_ratio(current.name, it.name) / 100;
                    // Adjusted weighting: more emphasis on partial ratio for product names
                    const score = 0.4 * simT + 0.6 * simP;
                    
                    // Only include items that meet the similarity threshold
                    if (score >= similarityThreshold) {
                        out.push({ item: it, score });
                    }
                }
                out.sort((a, b) => b.score - a.score);
                return out.slice(0, 10); // Still limit to top 10 for UI performance
            }, [current, items, session.labeled, similarityThreshold]);

            // Auto-select similar items
            useEffect(() => {
                // Only auto-select when moving to a new item, not on threshold changes
                if (!current) {
                    setSelectedBatch({});
                    return;
                }
                
                // Clear batch and auto-select for new item
                const newBatch = {};
                
                // Auto-select items that meet the threshold
                for (const s of similar) {
                    const itemId = s.item.product_id;
                    if (!session.labeled[itemId] && s.score >= similarityThreshold) {
                        newBatch[itemId] = true;
                    }
                }
                
                setSelectedBatch(newBatch);
            }, [current?.product_id]); // Only trigger on item change, not threshold change

            // Separate effect to handle threshold changes without overriding manual selections
            useEffect(() => {
                if (!current || similar.length === 0) return;
                
                // Debounce this effect to prevent rapid updates when adjusting threshold
                const timeoutId = setTimeout(() => {
                    setSelectedBatch(prev => {
                        const newBatch = {};
                        
                        // Keep existing manual selections for available items
                        const availableIds = new Set(similar.filter(s => !session.labeled[s.item.product_id]).map(s => s.item.product_id));
                        
                        for (const [id, selected] of Object.entries(prev)) {
                            if (availableIds.has(id)) {
                                newBatch[id] = selected; // Preserve manual choice
                            }
                        }
                        
                        // Only auto-select items that weren't previously in the batch
                        for (const s of similar) {
                            const itemId = s.item.product_id;
                            if (!session.labeled[itemId] && !(itemId in prev) && s.score >= similarityThreshold) {
                                newBatch[itemId] = true;
                            }
                        }
                        
                        return newBatch;
                    });
                }, 100); // 100ms debounce
                
                return () => clearTimeout(timeoutId);
            }, [similarityThreshold, similar, session.labeled]);

            function labelAndNext(l) {
                setSession((prev) => ({ 
                    labeled: { ...prev.labeled, [l.product_id]: l } 
                }));
                setStreak((s) => s + 1);
                
                setPendingReassign(null);
                // Stay at current index, the queue will automatically update and show next item
                // If we're at the end, the component will show completion screen
            }

            function batchApply(makeLabel) {
                const selectedIds = Object.entries(selectedBatch)
                    .filter(([, v]) => v)
                    .map(([k]) => k);
                    
                console.log('Batch apply - selectedBatch:', selectedBatch);
                console.log('Batch apply - selectedIds:', selectedIds);
                console.log('Batch apply - current item:', current?.product_id);
                
                const dict = {};
                if (current) dict[current.product_id] = makeLabel(current);
                
                for (const id of selectedIds) {
                    const it = items.find(x => x.product_id === id);
                    if (it) {
                        dict[id] = makeLabel(it);
                        console.log('Processing item:', it.product_id, it.name);
                    } else {
                        console.warn('Could not find item with ID:', id);
                    }
                }
                
                console.log('Total items being processed:', Object.keys(dict).length);
                
                for (const id of selectedIds) {
                    const it = items.find(x => x.product_id === id);
                    if (it) {
                        dict[id] = makeLabel(it);
                        console.log('Processing item:', it.product_id, it.name);
                    } else {
                        console.warn('Could not find item with ID:', id);
                    }
                }
                
                console.log('Total items being processed:', Object.keys(dict).length);
                
                setSession((prev) => ({ 
                    labeled: { ...prev.labeled, ...dict } 
                }));
                setStreak((s) => s + 1 + selectedIds.length);
                
                setPendingReassign(null);
                setSelectedBatch({}); // Clear the selected batch
                setLastSupplier(null); // Reset supplier tracking
                // Reset index to 0 to ensure we're at the start of the remaining queue
                setIndex(0);
            }

            function handleAccept() {
                if (!current) return;
                batchApply((it) => ({
                    ...it,
                    decision: "accept",
                    final_class: it.suggested ?? "UNKNOWN",
                    decided_at: new Date().toISOString(),
                }));
            }

            function onReassignConfirm() {
                if (!current || !pendingReassign) return;
                const target = pendingReassign;
                batchApply((it) => ({
                    ...it,
                    decision: "reassign",
                    final_class: target,
                    decided_at: new Date().toISOString(),
                }));
            }

            // Category descriptions embedded from construction_categories.csv
            const CATEGORY_DESCRIPTIONS = {
                "Aggregate": "Loose granular materials like gravel, sand, crushed stone for foundations, concrete, and drainage.",
                "Asphalt": "Bitumen-based road surfacing and roofing materials.",
                "Cladding": "External wall covering systems and panels for buildings.",
                "Concrete": "Ready-mix concrete and site-mixed concrete supplies.",
                "Electrical": "Cables, fittings, distribution boards, lighting, and electrical fixtures.",
                "Finishes": "Materials used to finish surfaces (paint, coatings, sealants, flooring, tiles).",
                "Fuels": "Fuel products such as diesel, petrol, heating oil, propane.",
                "Furnishings": "Furniture and interior fit-out products (desks, seating, storage).",
                "Insulation": "Thermal and acoustic insulation products (batts, boards, spray foam).",
                "Bricks and Blocks": "Bricks, blocks, stone, mortar, and associated walling materials.",
                "Mechanical": "HVAC and mechanical systems (ducting, fans, boilers, heat pumps).",
                "Network Systems": "ICT infrastructure supplies (data cabling, networking hardware, telecoms).",
                "Metals": "Metal stock materials (steel plate, sheet metal, sections not classified as structural).",
                "Openings": "Doors, windows, frames, shutters, and related ironmongery.",
                "Plasterboard": "Plasterboard, drywall boards, and accessories like jointing compounds.",
                "Plumbing": "Pipes, fittings, valves, fixtures for water, waste, and heating systems.",
                "Precast concrete": "Factory-made concrete components (panels, beams, manholes, blocks).",
                "Rebar": "Reinforcing bars, mesh, and steel reinforcement accessories.",
                "Structural Steel": "Structural steel beams, columns, frames, and related fabrication.",
                "Timber": "Structural and joinery timber, sheet timber products (ply, OSB, MDF).",
                "Aluminium": "Aluminium profiles, sheets, and architectural components.",
                "Glass": "Glass sheets, glazing units, and specialist glass products.",
                "Cement": "Bagged cement, additives, grout, and cementitious binders.",
                "Earthworks": "Soils, subsoil, aggregates for fill, and materials for earthmoving.",
                "Tools and Equipment": "Site tools, machinery, power tools, and plant hire.",
                "Fasteners": "Fixings such as screws, bolts, anchors, nails, and brackets.",
                "Other": "Items that do not clearly fall into any of the categories."
            };

            // Load category descriptions from construction_categories.csv
            function loadCategories() {
                fetch('./construction_categories.csv')
                    .then(response => response.text())
                    .then(csvText => {
                        Papa.parse(csvText, {
                            header: true,
                            skipEmptyLines: true,
                            complete: (res) => {
                                const categoryMap = {};
                                res.data.forEach(row => {
                                    if (row.Category && row.Description) {
                                        categoryMap[row.Category] = row.Description;
                                    }
                                });
                                setCategories(categoryMap);
                                console.log('Loaded category descriptions:', Object.keys(categoryMap).length);
                            }
                        });
                    })
                    .catch(err => {
                        console.warn('Could not load category descriptions from CSV, using embedded data:', err);
                        // Fallback to embedded descriptions
                        setCategories(CATEGORY_DESCRIPTIONS);
                    });
            }

            // Load categories on component mount
            useEffect(() => {
                loadCategories();
            }, []);

            // Debug: Log when categories change
            useEffect(() => {
                console.log('Categories updated:', categories);
                console.log('Available categories:', Object.keys(categories));
            }, [categories]);

            // Keyboard shortcuts
            useEffect(() => {
                function handleKeyDown(e) {
                    // Prevent shortcuts when typing in input fields or dropdowns
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
                    
                    switch(e.key.toLowerCase()) {
                        case 'a':
                            e.preventDefault();
                            handleAccept();
                            break;
                        case 'r':
                            e.preventDefault();
                            // Focus the reassign dropdown if it exists
                            const reassignSelect = document.querySelector('select');
                            if (reassignSelect) {
                                reassignSelect.focus();
                            }
                            break;
                        case 's':
                            e.preventDefault();
                            // Trigger reassign if a category is selected
                            if (pendingReassign) {
                                onReassignConfirm();
                            }
                            break;
                    }
                }
                
                document.addEventListener('keydown', handleKeyDown);
                return () => document.removeEventListener('keydown', handleKeyDown);
            }, [current, handleAccept, onReassignConfirm]);

            // Open product search in new tab
            function searchProductInfo() {
                if (!current?.name) return;
                
                // Combine with AI-friendly prompt for better search results
                const productInfo = current.supplier && current.supplier !== "" 
                    ? `${current.supplier} ${current.name}`
                    : current.name;
                
                const searchText = `what type of product is a ${productInfo}`;
                const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(searchText)}`;
                
                window.open(searchUrl, '_blank');
            }

            // Open supplier search in new tab
            function searchSupplierInfo() {
                if (!current?.supplier || current.supplier === "") return;
                
                const searchText = `what does the supplier ${current.supplier} specialise in selling`;
                const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(searchText)}`;
                
                window.open(searchUrl, '_blank');
            }

            function handleUploadCSV(file) {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (res) => {
                        const rows = res.data.map((r, index) => ({
                            product_id: String(r.product_id ?? r.id ?? `generated_${Date.now()}_${index}`),
                            supplier: String(r.supplier ?? r.vendor ?? ""),
                            name: String(r.name ?? r.title ?? ""),
                            suggested: r.suggested ? String(r.suggested) : undefined,
                            confidence: r.confidence ? Number(r.confidence) : undefined,
                        }));
                        
                        // Filter out rows with invalid data and ensure unique IDs
                        const validRows = rows.filter((r) => r.name && r.name !== "" && r.name !== "#REF!");
                        
                        // Check for duplicate product_ids and make them unique
                        const seenIds = new Set();
                        const uniqueRows = validRows.map((row, index) => {
                            let id = row.product_id;
                            
                            // Handle common Excel error values and invalid IDs
                            if (id === "#REF!" || id === "#N/A" || id === "#VALUE!" || id === "#DIV/0!" || id === "" || id === "undefined" || id === "null") {
                                id = `cleaned_${Date.now()}_${index}`;
                            }
                            
                            // Ensure uniqueness
                            let finalId = id;
                            let counter = 1;
                            while (seenIds.has(finalId)) {
                                finalId = `${id}_${counter}`;
                                counter++;
                            }
                            seenIds.add(finalId);
                            
                            return {
                                ...row,
                                product_id: finalId
                            };
                        });
                        
                        console.log(`Loaded ${uniqueRows.length} valid items (filtered out ${rows.length - uniqueRows.length} invalid items)`);
                        setItems(uniqueRows);
                        setIndex(0);
                    },
                });
            }

            function handleExportCSV() {
                const labeled = Object.values(session.labeled);
                const csv = Papa.unparse(labeled);
                const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `labels_${new Date().toISOString().slice(0,10)}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            }

            function handleReset() {
                if (confirm("Are you sure you want to reset all progress? This will clear all your classifications and cannot be undone.")) {
                    setSession({ labeled: {} });
                    setIndex(0);
                    setStreak(0);
                    setPendingReassign(null);
                    setSelectedBatch({});
                    setLastSupplier(null);
                    localStorage.removeItem(STORAGE_KEY);
                }
            }

            return (
                <div className="min-h-screen" style={{background: "linear-gradient(to bottom, #f8fafc, white)", padding: "24px"}}>
                    
                    <div style={{maxWidth: "1200px", margin: "0 auto", display: "flex", flexDirection: "column", gap: "24px"}}>
                        <header style={{display: "flex", alignItems: "center", justifyContent: "space-between"}}>
                            <div>
                                <h1 style={{fontSize: "32px", fontWeight: "bold", margin: 0}}>Product Group Reviewer</h1>
                            </div>
                            <div style={{display: "flex", alignItems: "center", gap: "8px"}}>
                                <Badge>Streak: {streak}</Badge>
                                <Button variant="outline" onClick={handleExportCSV}>
                                    ðŸ“¥ Export Labels
                                </Button>
                                <Button variant="outline" onClick={handleReset}>
                                    ðŸ”„ Reset Progress
                                </Button>
                            </div>
                        </header>

                        <div style={{display: "grid", gridTemplateColumns: "2fr 1fr", gap: "16px", alignItems: "center"}}>
                            <div>
                                <div style={{display: "flex", alignItems: "center", gap: "12px"}}>
                                    <div style={{flex: 1}}>
                                        <Progress value={progress} />
                                        <div style={{display: "flex", justifyContent: "space-between", fontSize: "12px", color: "#64748b", marginTop: "4px"}}>
                                            <span>{completed} / {total} labeled</span>
                                            <span>{progress}% complete</span>
                                        </div>
                                    </div>
                                    <div style={{display: "flex", flexDirection: "column", gap: "8px"}}>
                                        <div style={{display: "flex", alignItems: "center", gap: "8px"}}>
                                            <Switch checked={groupBySupplier} onCheckedChange={setGroupBySupplier} />
                                            <span style={{fontSize: "14px", color: "#374151"}}>Group by supplier</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style={{display: "flex", justifyContent: "flex-end", gap: "8px"}}>
                                <label style={{display: "inline-flex", alignItems: "center", gap: "8px", cursor: "pointer"}}>
                                    ðŸ“¤
                                    <input 
                                        type="file" 
                                        accept=".csv" 
                                        className="input"
                                        onChange={(e) => {
                                            const f = e.target.files?.[0];
                                            if (f) handleUploadCSV(f);
                                        }} 
                                    />
                                </label>
                            </div>
                        </div>

                        <Card>
                            {current ? (
                                <div>
                                    {/* Supplier context indicator when grouping by supplier */}
                                    {groupBySupplier && (
                                        <div style={{
                                            background: "#f8fafc", 
                                            border: "1px solid #e2e8f0", 
                                            borderRadius: "6px", 
                                            padding: "12px", 
                                            marginBottom: "16px",
                                            fontSize: "14px",
                                            color: "#475569"
                                        }}>
                                            {(() => {
                                                const currentSupplier = current.supplier || "(unknown)";
                                                const supplierProducts = queue.filter(p => (p.supplier || "(unknown)") === currentSupplier);
                                                const currentIndex = queue.indexOf(current);
                                                const supplierIndex = supplierProducts.indexOf(current) + 1;
                                                
                                                // Find most common classification for this supplier
                                                const supplierLabeled = Object.values(session.labeled)
                                                    .filter(item => (item.supplier || "(unknown)") === currentSupplier);
                                                
                                                let mostCommonClass = null;
                                                if (supplierLabeled.length > 0) {
                                                    const classCounts = {};
                                                    supplierLabeled.forEach(item => {
                                                        const finalClass = item.final_class;
                                                        if (finalClass) {
                                                            classCounts[finalClass] = (classCounts[finalClass] || 0) + 1;
                                                        }
                                                    });
                                                    
                                                    if (Object.keys(classCounts).length > 0) {
                                                        mostCommonClass = Object.entries(classCounts)
                                                            .sort(([,a], [,b]) => b - a)[0];
                                                    }
                                                }
                                                
                                                return (
                                                    <div style={{display: "flex", alignItems: "center", justifyContent: "space-between"}}>
                                                        <span>
                                                            ðŸ“¦ <strong>{currentSupplier}</strong> 
                                                            <span style={{color: "#64748b", marginLeft: "8px"}}>
                                                                ({supplierIndex}/{supplierProducts.length} products)
                                                            </span>
                                                            {mostCommonClass && (
                                                                <span style={{
                                                                    marginLeft: "12px",
                                                                    fontSize: "12px",
                                                                    background: "#e0f2fe",
                                                                    color: "#0c4a6e",
                                                                    padding: "2px 6px",
                                                                    borderRadius: "4px",
                                                                    fontWeight: "500"
                                                                }}>
                                                                    Most used: {mostCommonClass[0]} ({mostCommonClass[1]}x)
                                                                </span>
                                                            )}
                                                        </span>
                                                        <span style={{color: "#64748b", fontSize: "12px"}}>
                                                            Queue: {currentIndex + 1}/{queue.length}
                                                        </span>
                                                    </div>
                                                );
                                            })()}
                                        </div>
                                    )}
                                    
                                    <div style={{display: "grid", gridTemplateColumns: "2fr 1fr", gap: "24px"}}>
                                        {/* Main detail */}
                                        <div style={{display: "flex", flexDirection: "column", gap: "16px"}}>
                                            <div>
                                            <div style={{fontSize: "12px", textTransform: "uppercase", letterSpacing: "0.05em", color: "#64748b"}}>
                                                Supplier
                                            </div>
                                            <div style={{fontSize: "18px", fontWeight: "500", marginTop: "4px", display: "flex", alignItems: "center", gap: "8px"}}>
                                                <span>{current.supplier || <em style={{color: "#94a3b8"}}>(unknown)</em>}</span>
                                                {current.supplier && current.supplier !== "" && (
                                                    <button 
                                                        onClick={searchSupplierInfo} 
                                                        className="copy-supplier-btn text-slate-500 hover:text-slate-700 transition-colors p-1 rounded"
                                                        style={{
                                                            background: "none",
                                                            border: "none",
                                                            cursor: "pointer",
                                                            fontSize: "14px",
                                                            padding: "2px 4px",
                                                            borderRadius: "4px"
                                                        }}
                                                        onMouseOver={(e) => {
                                                            e.target.style.background = "#f1f5f9";
                                                            e.target.style.color = "#334155";
                                                        }}
                                                        onMouseOut={(e) => {
                                                            e.target.style.background = "none";
                                                            e.target.style.color = "#64748b";
                                                        }}
                                                        title="Search supplier specialisation"
                                                    >
                                                        ï¿½
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <div style={{fontSize: "12px", textTransform: "uppercase", letterSpacing: "0.05em", color: "#64748b"}}>
                                                Product Name
                                            </div>
                                            <div style={{display: "flex", alignItems: "center", gap: "8px", marginTop: "4px"}}>
                                                <div style={{fontSize: "20px", fontWeight: "600", lineHeight: "1.3", flex: 1}}>
                                                    {current.name}
                                                </div>
                                                <button 
                                                    className="copy-btn"
                                                    onClick={searchProductInfo}
                                                    style={{
                                                        background: "none",
                                                        border: "1px solid #e5e7eb",
                                                        borderRadius: "4px",
                                                        padding: "4px 6px",
                                                        cursor: "pointer",
                                                        color: "#64748b",
                                                        fontSize: "12px",
                                                        display: "flex",
                                                        alignItems: "center",
                                                        transition: "all 0.2s"
                                                    }}
                                                    onMouseOver={(e) => {
                                                        e.target.style.background = "#f9fafb";
                                                        e.target.style.color = "#374151";
                                                    }}
                                                    onMouseOut={(e) => {
                                                        e.target.style.background = "none";
                                                        e.target.style.color = "#64748b";
                                                    }}
                                                    title="Search product information"
                                                >
                                                    ï¿½
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <div style={{fontSize: "12px", textTransform: "uppercase", letterSpacing: "0.05em", color: "#64748b"}}>
                                                LLM Suggested Group
                                            </div>
                                            <div style={{display: "flex", alignItems: "center", gap: "8px", marginTop: "4px"}}>
                                                <Badge>{current.suggested ?? "(none)"}</Badge>
                                                {typeof current.confidence === "number" && (
                                                    <span style={{fontSize: "12px", color: "#64748b"}}>
                                                        conf: {(current.confidence*100).toFixed(0)}%
                                                    </span>
                                                )}
                                            </div>
                                        </div>

                                        {/* Category Description */}
                                        {current.suggested && categories[current.suggested] && (
                                            <div style={{
                                                backgroundColor: "#f8fafc", 
                                                border: "1px solid #e2e8f0", 
                                                borderRadius: "8px", 
                                                padding: "12px",
                                                marginTop: "12px"
                                            }}>
                                                <div style={{fontSize: "13px", color: "#475569", lineHeight: "1.4"}}>
                                                    {categories[current.suggested]}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* Debug info - remove this later */}
                                        {current.suggested && !categories[current.suggested] && (
                                            <div style={{fontSize: "11px", color: "#ef4444", marginTop: "8px"}}>
                                                Debug: No description found for "{current.suggested}". Available: {Object.keys(categories).join(', ')}
                                            </div>
                                        )}

                                        {/* Actions */}
                                        <div style={{display: "grid", gridTemplateColumns: "auto 1fr", gap: "8px", marginTop: "8px"}}>
                                            <Button variant="success" onClick={handleAccept}>
                                                âœ“ Accept (A)
                                            </Button>

                                            <div style={{display: "flex", gap: "8px"}}>
                                                <Select 
                                                    value={pendingReassign || ""}
                                                    onValueChange={setPendingReassign} 
                                                    placeholder="Reassign toâ€¦ (R)"
                                                >
                                                    {classes.map((c) => (
                                                        <SelectItem key={c} value={c}>{c}</SelectItem>
                                                    ))}
                                                </Select>
                                                <Button 
                                                    variant="primary" 
                                                    onClick={onReassignConfirm} 
                                                    disabled={!pendingReassign}
                                                >
                                                    Reassign (S)
                                                </Button>
                                            </div>
                                        </div>

                                        {/* Reassign Category Description */}
                                        {pendingReassign && categories[pendingReassign] && (
                                            <div style={{
                                                backgroundColor: "#eff6ff", 
                                                border: "1px solid #3b82f6", 
                                                borderRadius: "8px", 
                                                padding: "12px",
                                                marginTop: "12px"
                                            }}>
                                                <div style={{fontSize: "11px", textTransform: "uppercase", letterSpacing: "0.05em", color: "#1e40af", marginBottom: "4px", fontWeight: "600"}}>
                                                    {pendingReassign} Description
                                                </div>
                                                <div style={{fontSize: "13px", color: "#1e40af", lineHeight: "1.4"}}>
                                                    {categories[pendingReassign]}
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Similar items sidebar */}
                                    <div style={{borderLeft: "1px solid #e5e7eb", paddingLeft: "24px"}}>
                                        <h3 style={{fontSize: "16px", fontWeight: "600", marginBottom: "12px"}}>
                                            ðŸ” Similar Items
                                        </h3>
                                        
                                        <div style={{marginBottom: "12px"}}>
                                            <label style={{fontSize: "12px", color: "#64748b"}}>
                                                Similarity threshold: {similarityThreshold.toFixed(2)}
                                            </label>
                                            <input 
                                                type="range"
                                                min="0.3"
                                                max="1.0"
                                                step="0.05"
                                                value={similarityThreshold}
                                                onChange={(e) => setSimilarityThreshold(Number(e.target.value))}
                                                style={{width: "100%", marginTop: "4px"}}
                                            />
                                        </div>

                                        <div style={{fontSize: "12px", color: "#64748b", marginBottom: "8px"}}>
                                            Select items to apply the same action:
                                        </div>

                                        <div style={{maxHeight: "300px", overflowY: "auto", display: "flex", flexDirection: "column", gap: "8px"}}>
                                            {similar.length === 0 ? (
                                                <div style={{fontSize: "12px", color: "#94a3b8", fontStyle: "italic"}}>
                                                    No similar items found
                                                </div>
                                            ) : (
                                                similar.map(({ item, score }) => {
                                                    // Only show items that haven't been labeled
                                                    if (session.labeled[item.product_id]) return null;
                                                    
                                                    return (
                                                        <div 
                                                            key={item.product_id}
                                                            style={{
                                                                display: "flex",
                                                                alignItems: "flex-start",
                                                                gap: "8px",
                                                                padding: "8px",
                                                                border: "1px solid #e5e7eb",
                                                                borderRadius: "6px",
                                                                background: selectedBatch[item.product_id] ? "#eff6ff" : "white"
                                                            }}
                                                        >
                                                            <Checkbox
                                                                checked={selectedBatch[item.product_id] || false}
                                                                onCheckedChange={(checked) => 
                                                                    setSelectedBatch(prev => ({
                                                                        ...prev,
                                                                        [item.product_id]: checked
                                                                    }))
                                                                }
                                                            />
                                                            <div style={{flex: 1, minWidth: 0}}>
                                                                <div style={{
                                                                    fontSize: "13px",
                                                                    fontWeight: "500",
                                                                    overflow: "hidden",
                                                                    textOverflow: "ellipsis",
                                                                    whiteSpace: "nowrap"
                                                                }}>
                                                                    {item.name}
                                                                </div>
                                                                <div style={{fontSize: "11px", color: "#64748b"}}>
                                                                    {item.supplier} â€¢ {(score * 100).toFixed(0)}% match
                                                                </div>
                                                            </div>
                                                        </div>
                                                    );
                                                }).filter(Boolean)
                                            )}
                                        </div>

                                        {Object.values(selectedBatch).some(Boolean) && (
                                            <div style={{marginTop: "12px", padding: "8px", background: "#f0f9ff", borderRadius: "6px", border: "1px solid #0ea5e9"}}>
                                                <div style={{fontSize: "12px", color: "#0c4a6e", fontWeight: "500"}}>
                                                    Batch Action Preview
                                                </div>
                                                <div style={{fontSize: "11px", color: "#075985", marginTop: "2px"}}>
                                                    {(() => {
                                                        const selectedCount = Object.values(selectedBatch).filter(Boolean).length;
                                                        const visibleSelectedCount = Object.entries(selectedBatch)
                                                            .filter(([id, selected]) => selected && similar.some(s => s.item.product_id === id))
                                                            .length;
                                                        const hiddenCount = selectedCount - visibleSelectedCount;
                                                        
                                                        return `${1 + selectedCount} items will be processed together` + 
                                                               (hiddenCount > 0 ? ` (${hiddenCount} hidden by threshold)` : '');
                                                    })()}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                            ) : (
                                <div style={{textAlign: "center", padding: "48px"}}>
                                    <h2 style={{fontSize: "24px", fontWeight: "600", marginBottom: "8px"}}>
                                        ðŸŽ‰ All items reviewed!
                                    </h2>
                                    <p style={{color: "#64748b", marginBottom: "16px"}}>
                                        You've completed the review of all {total} products.
                                    </p>
                                    <div style={{marginBottom: "16px"}}>
                                        <Button onClick={handleExportCSV}>
                                            ðŸ“¥ Export Final Results
                                        </Button>
                                        <Button variant="outline" onClick={handleReset} style={{marginLeft: "8px"}}>
                                            ðŸ”„ Start Over
                                        </Button>
                                    </div>
                                </div>
                            )}
                        </Card>
                    </div>
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ProductGroupReviewer />);
    </script>
</body>
</html>